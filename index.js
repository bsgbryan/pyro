// Generated by CoffeeScript 1.8.0
(function() {
  var Firebase, add_leaf, add_value, find, firebase, get, increment_count, priority, push, q, sanitize, set, touch, watch;

  Firebase = require('firebase');

  firebase = new Firebase(process.env.FIREBASE_ROOT);

  q = require('q');

  if (process.env.FIREBASE_KEY != null) {
    firebase.auth(process.env.FIREBASE_KEY, function() {
      return console.log('AUTHED');
    });
  }

  Array.prototype.last = function() {
    return this[this.length - 1];
  };

  sanitize = function(location) {
    return location.replace(/\.|#|\$|\[|\]/g, '');
  };

  get = function(location) {
    var deferred;
    deferred = q.defer();
    firebase.child(sanitize(location)).once('value', function(snapshot) {
      return deferred.resolve(snapshot.val());
    });
    return deferred.promise;
  };

  set = function(location, value, p) {
    var deferred, loc;
    deferred = q.defer();
    loc = sanitize(location);
    p = p || priority(loc, value);
    firebase.child(loc).setWithPriority(value, p, function(err) {
      if (err != null) {
        return deferred.reject(err);
      } else {
        return deferred.resolve(true);
      }
    });
    return deferred.promise;
  };

  add_value = function(location, value, p) {
    var deferred;
    deferred = q.defer();
    get(location).then(function(val) {
      if (val != null) {
        return deferred.resolve(false);
      } else {
        return set(location, value, p).then(function() {
          return deferred.resolve(true);
        }).fail(function(err) {
          return deferred.reject(err);
        });
      }
    });
    return deferred.promise;
  };

  add_leaf = function(location, value, p) {
    var deferred;
    deferred = q.defer();
    get("" + location + "/" + value).then(function(val) {
      if (val != null) {
        return deferred.resolve(false);
      } else {
        return set("" + location + "/" + value, Date.now(), p).then(function() {
          return deferred.resolve(true);
        }).fail(function(err) {
          return deferred.reject(err);
        });
      }
    });
    return deferred.promise;
  };

  push = function(location, value) {
    var deferred;
    deferred = q.defer();
    firebase.child(location).push(value, function(err) {
      if (err != null) {
        return deferred.reject(err);
      } else {
        return deferred.resolve(true);
      }
    });
    return deferred.promise;
  };

  find = function(path, beginning) {
    var deferred;
    deferred = q.defer();
    firebase.child(sanitize(path)).startAt(beginning).on('child_added', function(snapshot) {
      return deferred.notify({
        name: snapshot.name(),
        value: snapshot.val()
      });
    });
    return deferred.promise;
  };

  touch = function(location, p) {
    var deferred, loc;
    deferred = q.defer();
    loc = sanitize(location);
    firebase.child(loc).setPriority(p || priority(loc), function(err) {
      if (err != null) {
        return deferred.reject(err);
      } else {
        return deferred.resolve(true);
      }
    });
    return deferred.promise;
  };

  increment_count = function(location) {
    var count, deferred, loc;
    deferred = q.defer();
    loc = sanitize(location);
    count = "" + loc + "/_count_";
    firebase.child(count).once('value', function(snapshot) {
      var val;
      val = snapshot.val() || 0;
      return firebase.child(count).setWithPriority(++val, priority(loc, val), function(err) {
        if (err != null) {
          return deferred.reject({
            context: 'pyro/increment_count',
            error: err
          });
        } else {
          return deferred.resolve();
        }
      });
    });
    return deferred.promise;
  };

  priority = function(location, value) {
    return Date.now();
  };

  watch = function(path, event) {
    var base, deep, deferred, idx;
    deferred = q.defer();
    idx = path.indexOf('*');
    if (idx > 0) {
      deep = path.split('/');
      base = sanitize(path.slice(0, +(idx - 2) + 1 || 9e9));
      firebase.child(base).on("child_" + event, function(snapshot) {
        return firebase.child("" + base + "/" + (snapshot.name())).on("child_" + event, function(snap) {
          return deferred.notify({
            name: decodeURIComponent(snapshot.name()),
            article: snap.name(),
            sentiment: snap.val(),
            relevance: snap.getPriority()
          });
        });
      });
    } else {
      firebase.child(sanitize(path)).on("child_" + event, function(snap) {
        return deferred.notify({
          name: snap.name(),
          value: snap.val(),
          priority: snap.getPriority()
        });
      });
    }
    return deferred.promise;
  };

  module.exports = {
    get: get,
    set: set,
    push: push,
    find: find,
    watch: watch,
    priority: priority,
    add_leaf: add_leaf,
    add_value: add_value,
    increment_count: increment_count
  };

}).call(this);
